<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>콘텐츠 갤러리 및 뷰어 (외부 Manifest 로딩)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans KR', 'sans-serif'],
                    },
                    colors: {
                        'primary-blue': '#1D4ED8',
                        'secondary-gray': '#F3F4F6',
                    }
                }
            }
        }
    </script>
    <style>
        /* 커스텀 스크롤바 스타일 */
        #content-list {
            max-height: calc(100vh - 4rem); /* 헤더 높이를 제외 */
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        #content-list::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

<header class="bg-white shadow-md p-4 sticky top-0 z-10">
    <h1 class="text-2xl font-bold text-primary-blue">
        📦 콘텐츠 갤러리 및 뷰어
    </h1>
    <p class="text-sm text-gray-500 mt-1">
        왼쪽 목록에서 항목을 선택하면 콘텐츠가 로드됩니다.
    </p>
</header>

<main class="flex flex-1 overflow-hidden">

    <aside id="content-list" class="w-full md:w-1/4 bg-secondary-gray border-r border-gray-200 p-4 flex-shrink-0">

        <button onclick="showPostModal()"
                class="w-full bg-primary-blue hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 mb-4 shadow-md flex items-center justify-center">
            <span class="text-xl mr-2">+</span> 글 추가하기
        </button>

        <h2 class="text-lg font-semibold mb-3 mt-1 text-gray-700 border-b pb-2 flex items-center">
            <span class="text-xl mr-2">📝</span> 글 섹션
        </h2>
        <ul id="text-list-container" class="space-y-2 mb-6">
        </ul>

        <h2 class="text-lg font-semibold mb-3 mt-6 text-gray-700 border-b pb-2 flex items-center">
            <span class="text-xl mr-2">🖼️</span> 이미지 섹션
        </h2>
        <ul id="image-list-container" class="space-y-2">
        </ul>

        <div id="sidebar-loading-message" class="text-center p-4">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary-blue mx-auto"></div>
            <p class="text-sm text-primary-blue mt-2">콘텐츠 목록 로딩 중...</p>
        </div>

        <div id="loading-message" class="text-center p-4 hidden">
        </div>
    </aside>

    <section id="content-viewer" class="flex-1 p-6 overflow-y-auto bg-white">
        <div id="viewer-container" class="max-w-4xl mx-auto">
            <h2 class="text-xl font-bold mb-4 text-gray-700">콘텐츠를 선택해 주세요</h2>
            <p class="text-gray-500">
                왼쪽 목록에서 보고 싶은 글이나 이미지를 클릭하세요.
            </p>
        </div>

        <div id="error-box" class="hidden mt-8 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
            <strong class="font-bold">⚠️ 오류 발생:</strong>
            <span class="block sm:inline" id="error-message"></span>
        </div>
    </section>

</main>

<div id="confirm-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 m-4 relative">
        <h3 class="text-xl font-bold mb-4 text-red-600 border-b pb-2">⚠️ 삭제 확인</h3>
        <p id="confirm-message" class="mb-6 text-gray-700">정말로 "<span id="delete-item-title" class="font-semibold"></span>" 항목을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.</p>

        <div class="flex justify-end space-x-3">
            <button id="cancel-delete-button" type="button"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                취소
            </button>
            <button id="execute-delete-button" type="button"
                    class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150">
                영구 삭제
            </button>
        </div>
    </div>
</div>
<div id="post-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 m-4 relative">

        <h3 class="text-2xl font-bold mb-4 text-primary-blue border-b pb-2">📝 새 글 작성하기</h3>

        <form id="post-form" onsubmit="event.preventDefault(); submitPost();">
            <div class="mb-4">
                <label for="post-title" class="block text-sm font-medium text-gray-700 mb-1">제목</label>
                <input type="text" id="post-title" required
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
            </div>
            <div class="mb-6">
                <label for="post-content" class="block text-sm font-medium text-gray-700 mb-1">글 내용</label>
                <textarea id="post-content" rows="8" required
                          class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150"></textarea>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hidePostModal()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition duration-150">
                    취소
                </button>
                <button type="submit" id="submit-button"
                        class="px-4 py-2 text-sm font-medium text-white bg-primary-blue rounded-lg hover:bg-blue-700 transition duration-150">
                    작성 완료 및 저장
                </button>
            </div>

            <div id="post-message" class="mt-4 p-3 text-sm rounded-lg hidden"></div>
        </form>

        <button onclick="hidePostModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
</div>
<script>
    // === 환경 설정 ===
    const API_MANIFEST_URL = '/content_manifest.json';
    const API_POST_URL = '/api/posts'; // 서버의 PostCreationHandler로 요청을 보낼 엔드포인트 (POST)
    const API_DELETE_URL = '/api/posts'; // 서버의 삭제 엔드포인트 (DELETE)

    let contents = [];
    let currentDeleteId = null; // 💡 현재 삭제 대기 중인 항목의 ID를 저장하는 전역 변수

    // DOM 요소 참조
    const textListContainer = document.getElementById('text-list-container');
    const imageListContainer = document.getElementById('image-list-container');
    const viewerContainer = document.getElementById('viewer-container');
    const errorBox = document.getElementById('error-box');
    const errorMessage = document.getElementById('error-message');
    const loadingMessage = document.getElementById('loading-message');
    const sidebarLoadingMessage = document.getElementById('sidebar-loading-message');

    // 모달 관련 DOM 참조
    const postModal = document.getElementById('post-modal');
    const postForm = document.getElementById('post-form');
    const postTitleInput = document.getElementById('post-title');
    const postContentTextarea = document.getElementById('post-content');
    const postMessageDiv = document.getElementById('post-message');
    const submitButton = document.getElementById('submit-button');

    // 삭제 모달 관련 DOM 참조
    const confirmModal = document.getElementById('confirm-modal');
    const deleteItemTitleSpan = document.getElementById('delete-item-title');
    const executeDeleteButton = document.getElementById('execute-delete-button');
    const cancelDeleteButton = document.getElementById('cancel-delete-button');


    // =========================================================================
    // === 유틸리티 함수 ===
    // =========================================================================

    /**
     * @description 에러 메시지를 표시합니다.
     */
    function showError(msg) {
        errorBox.classList.remove('hidden');
        errorMessage.textContent = msg;
        loadingMessage.classList.add('hidden');
    }

    /**
     * @description 에러 메시지를 숨깁니다.
     */
    function hideError() {
        errorBox.classList.add('hidden');
    }

    /**
     * @description 파일 경로에서 파일 확장자를 추출하여 타입을 반환합니다.
     */
    function getFileExtension(path) {
        return path.split('.').pop();
    }


    // =========================================================================
    // === 목록 로딩 및 렌더링 함수 ===
    // =========================================================================

    /**
     * @description 외부 JSON 파일로부터 콘텐츠 목록을 비동기적으로 가져옵니다.
     */
    async function fetchContents() {
        sidebarLoadingMessage.classList.remove('hidden');

        try {
            // 외부 JSON 파일 fetch 시도
            const response = await fetch(API_MANIFEST_URL);

            if (!response.ok) {
                throw new Error(`목록 파일 로드 실패: ${response.status} ${response.statusText}`);
            }

            contents = await response.json();

            if (!Array.isArray(contents)) {
                throw new Error("콘텐츠 Manifest 파일의 형식이 올바르지 않습니다. JSON 배열이어야 합니다.");
            }

        } catch (error) {
            console.error("콘텐츠 목록 로딩 중 오류 발생:", error);
            textListContainer.innerHTML = `<li class="text-red-500 text-sm">목록 로딩 실패: ${error.message}</li>`;
            imageListContainer.innerHTML = '';
        } finally {
            sidebarLoadingMessage.classList.add('hidden');
        }
    }

    /**
     * @description 콘텐츠 목록을 사이드바에 렌더링합니다.
     */
    function renderList() {
        textListContainer.innerHTML = '';
        imageListContainer.innerHTML = '';

        const textItems = contents.filter(item => item.type === 'text');
        const imageItems = contents.filter(item => item.type === 'image');

        if (textItems.length > 0) {
            textItems.forEach(item => { appendListItem(item, textListContainer); });
        } else {
            textListContainer.innerHTML = `<li class="text-gray-500 text-sm p-3">표시할 글이 없습니다.</li>`;
        }

        if (imageItems.length > 0) {
            imageItems.forEach(item => { appendListItem(item, imageListContainer); });
        } else {
            imageListContainer.innerHTML = `<li class="text-gray-500 text-sm p-3">표시할 이미지가 없습니다.</li>`;
        }
    }

    /**
     * @description 단일 목록 항목을 생성하고 컨테이너에 추가합니다.
     */
    function appendListItem(item, container) {
        const li = document.createElement('li');
        li.className = 'group relative'; // 마우스 오버 감지를 위한 group 클래스 추가

        // 콘텐츠 로딩 버튼
        const button = document.createElement('button');
        const icon = item.type === 'text'
            ? '<span class="mr-2 text-primary-blue">📖</span>'
            : '<span class="mr-2 text-primary-blue">📷</span>';

        button.className = 'w-full text-left p-3 rounded-lg hover:bg-white transition duration-200 flex items-center shadow-sm';
        button.innerHTML = `${icon} <span class="truncate pr-10">${item.title}</span>`;

        button.onclick = (e) => loadContent(item, e.currentTarget);

        li.appendChild(button);

        // 텍스트 타입인 경우에만 삭제 버튼 추가
        if (item.type === 'text') {
            const deleteBtn = document.createElement('button');
            // 휴지통 아이콘 (Lucide Icon SVG 사용)
            deleteBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                `;
            deleteBtn.className = 'absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-red-500 hover:text-red-700 transition duration-150 rounded-full bg-secondary-gray/50 hidden group-hover:block z-10';

            deleteBtn.onclick = (e) => {
                e.stopPropagation(); // 목록 클릭 이벤트 방지
                confirmAndDeletePost(item);
            };

            li.appendChild(deleteBtn);
        }

        container.appendChild(li);
    }

    // =========================================================================
    // === 콘텐츠 뷰어 함수 ===
    // =========================================================================

    /**
     * @description 메인 뷰어의 로딩 상태를 토글합니다.
     */
    function toggleLoading(isLoading) {
        if (isLoading) {
            viewerContainer.innerHTML = '';
            loadingMessage.classList.remove('hidden');
        } else {
            loadingMessage.classList.add('hidden');
        }
    }

    /**
     * @description API 경로에서 콘텐츠를 가져와 뷰어에 표시합니다.
     */
    async function loadContent(item, clickedButton) {
        document.querySelectorAll('#content-list button').forEach(btn => {
            // delete button이 아닌 load content button만 처리
            if (!btn.classList.contains('text-red-500')) {
                btn.classList.remove('bg-white', 'font-bold', 'text-primary-blue', 'ring-2', 'ring-primary-blue');
            }
        });
        // delete button에 대한 스타일이 겹치지 않도록 주의
        if (!clickedButton.classList.contains('text-red-500')) {
            clickedButton.classList.add('bg-white', 'font-bold', 'text-primary-blue', 'ring-2', 'ring-primary-blue');
        }


        hideError();
        toggleLoading(true);

        try {
            // --- 이미지 로드 로직 (플레이스홀더 및 실제 파일) ---
            if (item.type === 'image') {
                const fileExtension = getFileExtension(item.path).toUpperCase();
                let imageUrl = item.path;

                if (item.placeholder) { // 플레이스홀더 사용
                    imageUrl = `https://placehold.co/${item.placeholder}`;
                    console.log('[Image Load] Using Placeholder:', imageUrl);
                } else { // 실제 파일 로드 시도
                    console.log('[Image Load] Attempting to load actual file:', item.path);
                }

                // 이미지 로드 시에는 fetch 대신 <img> 태그 자체를 사용하여 브라우저가 로드를 담당하게 합니다.
                // 대신, 로드에 실패하면 onerror 이벤트로 처리합니다.

                viewerContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                            <h3 class="text-2xl font-bold mb-4 text-gray-800">${item.title}</h3>
                            <div class="relative w-full overflow-hidden rounded-xl bg-gray-50 p-2">
                                <img src="${imageUrl}" alt="${item.title}"
                                     class="w-full h-auto object-contain max-h-[70vh] rounded-lg mx-auto"
                                     onerror="handleImageLoadError(this, '${item.path}')" />
                            </div>
                            <p class="mt-4 text-gray-600 text-sm">
                                ID: <strong class="font-bold text-gray-800">${item.id}</strong> |
                                파일 타입: <strong class="uppercase">${fileExtension}</strong> |
                                이미지 경로: <code>${item.path}</code>
                            </p>
                        </div>
                    `;
                toggleLoading(false);
                return;
            }

            // --- 텍스트 콘텐츠 로드 로직 ---
            const response = await fetch(item.path);

            if (!response.ok) {
                throw new Error(`파일을 불러오지 못했습니다. (경로: ${item.path}, 상태 코드: ${response.status})`);
            }

            if (item.type === 'text') {
                const textContent = await response.text();
                const fileExtension = getFileExtension(item.path).toUpperCase();

                viewerContainer.innerHTML = `
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                            <h3 class="text-3xl font-extrabold mb-6 text-primary-blue border-b pb-3">${item.title}</h3>

                            <div class="mb-4 text-gray-600 text-sm">
                                ID: <strong class="font-bold text-gray-800">${item.id}</strong> |
                                파일 타입: <strong class="uppercase">${fileExtension}</strong> |
                                경로: <code>${item.path}</code>
                            </div>

                            <pre class="whitespace-pre-wrap font-mono p-4 bg-secondary-gray rounded-lg text-sm leading-relaxed border border-gray-200">
                                ${textContent}
                            </pre>
                        </div>
                    `;
            }
        } catch (error) {
            console.error("콘텐츠 로딩 중 오류 발생:", error);
            showError(`콘텐츠 로딩 중 문제가 발생했습니다: ${error.message}`);
            viewerContainer.innerHTML = `<p class="text-red-500 font-medium">콘텐츠를 불러오는 데 실패했습니다. 서버에 파일(경로: ${item.path})이 있는지 확인하세요.</p>`;

        } finally {
            toggleLoading(false);
        }
    }

    /**
     * @description 이미지 로드 실패 시 호출됩니다.
     */
    function handleImageLoadError(imgElement, path) {
        imgElement.onerror = null; // 재호출 방지
        imgElement.src = 'https://placehold.co/800x600/cccccc/000000?text=Image+Load+Failed'; // 대체 이미지 표시

        // 에러 메시지 업데이트
        const parentP = imgElement.closest('.bg-white').querySelector('p.text-gray-600');
        if (parentP) {
            parentP.innerHTML = `
                     <span class="text-red-500 font-bold">⚠️ 이미지 로드 실패:</span> 서버 경로 <code>${path}</code>에 파일이 없거나 접근할 수 없습니다.
                 `;
        }
        console.error(`Failed to load image at: ${path}. Check server directory /images/.`);
    }


    // =========================================================================
    // === 글쓰기 모달 함수 (POST) ===
    // =========================================================================

    /**
     * @description 글쓰기 모달을 표시하고 폼을 초기화합니다.
     */
    function showPostModal() {
        postModal.classList.remove('hidden');
        postModal.classList.add('flex');
        postForm.reset(); // 폼 내용 초기화
        postMessageDiv.classList.add('hidden'); // 메시지 숨김
        submitButton.disabled = false;
    }

    /**
     * @description 글쓰기 모달을 숨깁니다.
     */
    function hidePostModal() {
        postModal.classList.add('hidden');
        postModal.classList.remove('flex');
    }

    /**
     * @description 작성된 글을 서버로 POST 요청합니다.
     */
    async function submitPost() {
        const title = postTitleInput.value.trim();
        const content = postContentTextarea.value.trim();

        postMessageDiv.classList.add('hidden');
        submitButton.disabled = true;

        if (title === '' || content === '') {
            displayPostMessage('제목과 내용을 모두 입력해 주세요.', 'bg-yellow-100 text-yellow-800');
            submitButton.disabled = false;
            return;
        }

        const payload = JSON.stringify({
            title: title,
            content: content
        });

        try {
            const response = await fetch(API_POST_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: payload
            });

            if (response.ok) {
                const responseText = await response.text();
                displayPostMessage(`✅ 글 작성이 완료되었습니다! 서버 응답: ${responseText.substring(0, 50)}...`, 'bg-green-100 text-green-800');

                // 성공 후 3초 뒤 모달 닫고 목록 새로고침
                setTimeout(() => {
                    hidePostModal();
                    initializeApp(); // 목록 새로고침 및 첫 항목 로드
                }, 3000);

            } else {
                const errorBody = await response.text();
                throw new Error(`[${response.status}] ${response.statusText}. 응답 내용: ${errorBody.substring(0, 100)}...`);
            }
        } catch (error) {
            console.error("POST 요청 중 오류 발생:", error);
            displayPostMessage(`❌ 글 저장 실패: ${error.message}`, 'bg-red-100 text-red-800');
        } finally {
            submitButton.disabled = false;
        }
    }

    /**
     * @description 모달 내부에 메시지를 표시합니다.
     */
    function displayPostMessage(message, className) {
        postMessageDiv.textContent = message;
        postMessageDiv.className = `mt-4 p-3 text-sm rounded-lg ${className}`;
        postMessageDiv.classList.remove('hidden');
    }

    // =========================================================================
    // === 삭제 함수 (DELETE) ===
    // =========================================================================

    /**
     * @description 삭제 확인 모달을 표시하고 삭제할 ID를 저장합니다.
     */
    function confirmAndDeletePost(item) {
        currentDeleteId = item.id; // 💡 삭제할 ID를 전역 변수에 저장
        deleteItemTitleSpan.textContent = item.title;

        confirmModal.classList.remove('hidden');
        confirmModal.classList.add('flex');
    }

    /**
     * @description 삭제 확인 모달을 숨깁니다.
     */
    function hideConfirmModal() {
        confirmModal.classList.add('hidden');
        confirmModal.classList.remove('flex');
        currentDeleteId = null; // ID 초기화
    }

    /**
     * @description 서버에 DELETE 요청을 보냅니다. (전역 변수 currentDeleteId 사용)
     */
    async function deletePost() {
        const idToDelete = currentDeleteId;
        if (!idToDelete) {
            showError('삭제할 항목의 ID가 누락되었습니다.');
            return;
        }

        // 뷰어와 목록을 로딩 상태로 전환
        toggleLoading(true);
        hideError();

        try {
            // DELETE 요청을 보낼 엔드포인트: /api/posts/{id}
            const response = await fetch(`${API_DELETE_URL}/${idToDelete}`, {
                method: 'DELETE',
            });

            if (response.ok) {
                // 성공적으로 삭제되면 목록을 새로고침합니다.
                console.log(`✅ 글 (ID: ${idToDelete})이 성공적으로 삭제되었습니다.`);
                // 알림 메시지 표시 (임시)
                alert(`[삭제 성공] 항목 ID ${idToDelete}가 삭제되었습니다.`);
                hideConfirmModal();
                // 목록 새로고침
                initializeApp();

            } else {
                const errorBody = await response.text();
                throw new Error(`[${response.status}] ${response.statusText}. 서버 응답: ${errorBody.substring(0, 100)}...`);
            }
        } catch (error) {
            console.error("DELETE 요청 중 오류 발생:", error);
            showError(`삭제 실패: ${error.message}`);
            toggleLoading(false);
        }
    }

    /**
     * @description 삭제 모달 버튼에 이벤트 리스너를 한 번만 바인딩합니다.
     */
    function bindDeleteModalListeners() {
        // executeDeleteButton은 항상 deletePost() 함수를 호출합니다.
        executeDeleteButton.addEventListener('click', deletePost);

        // cancelDeleteButton은 모달을 숨깁니다.
        cancelDeleteButton.addEventListener('click', hideConfirmModal);

        // 모달 닫기 이벤트(배경 클릭 등)를 처리할 필요는 없으나,
        // 현재는 버튼 이벤트만 바인딩합니다.
    }


    // =========================================================================
    // === 초기화 함수 ===
    // =========================================================================

    async function initializeApp() {
        // 리스너는 앱이 로드될 때 한 번만 바인딩합니다. (중복 방지)
        if (!window.deleteListenersBound) {
            bindDeleteModalListeners();
            window.deleteListenersBound = true;
        }

        await fetchContents();
        renderList();

        // 첫 번째 글 항목의 ID를 가져와서 뷰어에 표시하는 것을 목표로 합니다.
        const firstButton = textListContainer.querySelector('button') || imageListContainer.querySelector('button');
        if (firstButton) {
            // DOM이 렌더링 된 후 클릭을 유발
            setTimeout(() => {
                firstButton.click();
            }, 100);
        } else {
            viewerContainer.innerHTML = '<p class="text-gray-500">표시할 콘텐츠 목록이 없습니다. Manifest 파일을 확인해주세요.</p>';
            toggleLoading(false);
        }
    }

    window.onload = initializeApp;

</script>
</body>
</html>